<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SCNG NL West Standings — Dodgers vs. Padres</title>

<style>
  :root{color-scheme:light only}
  html,body{margin:0;padding:0}
  body{padding:12px;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:740px;margin:0 auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:linear-gradient(90deg,var(--p,#0d47a1),var(--a,#1976d2));color:#fff}
  header h3{margin:0;font-size:16px;letter-spacing:.2px;font-weight:800}
  header .meta{font-size:12px;opacity:.95}
  .race{padding:12px;display:grid;gap:8px}
  .race .bar{height:10px;background:#e5e7eb;border-radius:999px;position:relative;overflow:hidden}
  .race .fill{position:absolute;top:0;bottom:0;width:50%;transition:width .3s ease;background:#fff;opacity:.7}
  .race .stats{display:flex;justify-content:space-between;font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
  th,td{padding:10px 12px;text-align:left}
  th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;background:#fafafa;position:sticky;top:0}
  tbody tr:nth-child(even){background:#f6f7f9}
  tbody tr.focus{background:#fff7cc}
  .error{padding:12px;color:#b91c1c;font-size:14px}
  @media (max-width:480px){ th.hide-sm, td.hide-sm { display:none; } }
</style>

<div class="wrap">
  <div id="widget" class="card">
    <header>
      <h3>NL West Standings</h3>
      <div class="meta"></div>
    </header>
    <div class="body"></div>
  </div>
</div>

<script>
(async () => {
  // --- Auto-brand: detect parent domain via referrer; fallback to ?brand= ---
  const brandMap = {
    'dailynews.com':'ladn',
    'ocregister.com':'ocr',
    'sgvtribune.com':'sgv',
    'dailybreeze.com':'db',
    'presstelegram.com':'pt',
    'sbsun.com':'sbs',
    'dailybulletin.com':'ivdb',
    'pasadenastarnews.com':'psn',
    'whittierdailynews.com':'wdn',
    'dailypilot.com':'dp'
  };
  const brandColors = {
    ladn:['#0d47a1','#1976d2'], ocr:['#0b3d91','#1e88e5'], sgv:['#334155','#64748b'],
    db:['#0f766e','#14b8a6'],   pt:['#1f2937','#4b5563'],   sbs:['#7c2d12','#ea580c'],
    ivdb:['#3b0764','#7c3aed'], psn:['#111827','#374151'], wdn:['#27272a','#52525b'],
    dp:['#1e3a8a','#2563eb'],  default:['#0d47a1','#1976d2']
  };
  const qs = new URLSearchParams(location.search);
  const qsBrand = (qs.get('brand') || '').toLowerCase();

  let host = '';
  try {
    host = new URL(document.referrer).hostname.toLowerCase().replace(/^www\./,'');
  } catch(e) {}

  const detected = brandMap[host];
  const brand = (qsBrand || detected || 'default');
  const [p,a] = brandColors[brand] || brandColors.default;
  document.documentElement.style.setProperty('--p', p);
  document.documentElement.style.setProperty('--a', a);

  // --- Header meta (season + timestamp) ---
  const meta = document.querySelector('.meta');
  const now = new Date();
  const season = now.getFullYear();
  meta.textContent = `${season} • Updated ${now.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'})}`;

  // --- Fetch MLB standings (NL) ---
  const urls = [
    `https://statsapi.mlb.com/api/v1/standings?leagueId=104&season=${season}&standingsType=regularSeason`,
    `https://statsapi.mlb.com/api/v1/standings?leagueId=104&season=${season}`
  ];
  let json = null;
  for (const u of urls) {
    try {
      const r = await fetch(u, {mode:'cors', credentials:'omit'});
      if (!r.ok) continue;
      const j = await r.json();
      if (j && j.records) { json = j; break; }
    } catch(_) {}
  }

  const body = document.querySelector('.body');
  if (!json) { body.innerHTML = `<div class="error">Standings temporarily unavailable.</div>`; return; }

  // --- Robust: pick the block that actually includes LAD (119) or SD (135) ---
  const records = Array.isArray(json.records) ? json.records : [];
  const rec =
    records.find(r => (r.teamRecords || []).some(tr =>
      tr?.team?.abbreviation === 'LAD' || tr?.team?.abbreviation === 'SD' ||
      tr?.team?.id === 119 || tr?.team?.id === 135
    )) ||
    records.find(r => /west/i.test(r?.division?.name || '') && /national/i.test(r?.league?.name || '')) ||
    records[0];

  if (!rec || !rec.teamRecords) { body.innerHTML = `<div class="error">NL West not found.</div>`; return; }

  const rows = rec.teamRecords;
  const find = (needle) => rows.find(tr => String(tr?.team?.id)===String(needle) || tr?.team?.abbreviation===needle);
  const dodgers = ['119','LAD'].map(find).find(Boolean);
  const padres  = ['135','SD' ].map(find).find(Boolean);

  const pct = (w,l) => (w+l) ? (w/(w+l)).toFixed(3).replace(/^0/,'') : '—';
  const gb  = (tr) => (tr && tr.gamesBack != null) ? tr.gamesBack : '—';

  function table(){
    return `
      <table aria-label="NL West standings table">
        <thead>
          <tr><th>#</th><th>Team</th><th>W</th><th>L</th><th>Pct</th><th class="hide-sm">GB</th></tr>
        </thead>
        <tbody>
          ${rows.map((tr,i)=>`
            <tr class="${(tr?.team?.id==119||tr?.team?.id==135||tr?.team?.abbreviation==='LAD'||tr?.team?.abbreviation==='SD')?'focus':''}">
              <td>${i+1}</td>
              <td>${tr?.team?.name || tr?.team?.abbreviation || '—'}</td>
              <td>${tr?.wins ?? '—'}</td>
              <td>${tr?.losses ?? '—'}</td>
              <td>${tr?.pct ? String(tr.pct).replace(/^0/,'') : pct(tr?.wins||0, tr?.losses||0)}</td>
              <td class="hide-sm">${gb(tr)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function race(){
    if (!dodgers || !padres) return '';
    const dW = +dodgers.wins||0, dL = +dodgers.losses||0;
    const pW = +padres.wins||0,  pL = +padres.losses||0;
    const diffRaw = (dW-dL) - (pW-pL);
    const ahead = diffRaw>0 ? 'Dodgers' : diffRaw<0 ? 'Padres' : 'Even';
    const diff = Math.abs(diffRaw)/2;
    const remain = Math.max(0, 162 - dW - dL);
    const magic = ahead==='Even' ? null : Math.max(0, Math.ceil(163 - (ahead==='Dodgers' ? (dW + pL) : (pW + dL))));
    const width = 50 + (diff ? (ahead==='Dodgers' ? diff : -diff) : 0)*5;
    return `
      <div class="race" aria-label="Dodgers–Padres race">
        <div class="stats">
          <div><strong>Dodgers</strong> ${dW}-${dL} <span class="badge">GB ${gb(dodgers)}</span></div>
          <div><strong>Padres</strong> ${pW}-${pL} <span class="badge">GB ${gb(padres)}</span></div>
        </div>
        <div class="bar"><div class="fill" style="width:${width}%"></div></div>
        <div class="stats">
          <div>${ahead==='Even' ? 'Even' : ahead + ' lead'} by ${diff.toFixed(1)} games</div>
          <div>${magic!=null ? 'Magic number: ' + magic : 'Games remaining: ' + remain}</div>
        </div>
      </div>
    `;
  }

  document.querySelector('.body').innerHTML = race() + table();
})();
</script>
</html>
